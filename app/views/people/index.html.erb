<% content_for :title, 'People - Phone book' %>
<% content_for :tablesorter do %>
    <%= javascript_include_tag 'tablesorter' %>
    <%= javascript_include_tag 'tablesorter_filter' %>
    <script type="text/javascript" >
      //var image_array = new Array();
        setInterval(function(){
              if(document.getElementById("hidden_field").value == "on"){

                  document.getElementById("hidden_field").value = "off";

                  var rows_list = document.getElementById("people_table").getElementsByTagName("TR");

                  if (rows_list.length > 1){

                      var loadImageForRow = function(row) {

                          var img = new Image();
                          img.width = 60
                          img.onload = function() {
                                      //console.log(row.find('.url_cell').value);
                                      if (!this.complete || typeof this.naturalWidth == 'undefined' || this.naturalWidth == 0) {
                                          // handle broken image
                                      } else {
                                          row.find('.image_cell').append(img);
                                          //row.getElementsByTagName('td').appendChild(img);
                                      }
                                  }
                          //console.log(row.find(".image_cell"));
                          img.src = row.find(".url_cell").html();

                      }

                      var rows = [];
                      //var ary = [];
                      for(var i=1; i<rows_list.length; i++){
                          rows.push(rows_list[i]);
                      }

                      $.each(rows,function(){
                      //rows.each(function(){
                          if (this.getElementsByTagName('td')[0].childElementCount<1 ){
                                       console.log("each hit");
                            loadImageForRow($(this));
                          }
                      });
                  }
              }
        },1000);

        $(document).ready(function () {

                    $("#people_table").hide();
                    $("#filterBoxOne").keyup(function() {
                        if(this.value.length > 0){
                            $("#people_table").show();
                            $("#key_contacts_table").hide();
                        }
                        else{
                            $("#people_table").hide();
                            $("#key_contacts_table").show();
                        }                                
                    });

                    if ($("#filterBoxOne").prop("disabled") == true) {
                        $('#filterBoxOne').val('');
                        $('#filterBoxOne').removeAttr("disabled");
                        $('#filterBoxOne').focus();
                    }
                    
                    $("#people_table").tablesorter({widgets:['zebra'],
                        headers:{0:{sorter:false}, 3:{sorter:false}  }
                    })
                            .tablesorterFilter({ filterContainer:$("#filterBoxOne"),
                                filterClearContainer:$("#filterClearOne"),
                                filterColumns:[0, 1, 2],
                                filterCaseSensitive:false
                            })
                            ;

                    //scroll the message box to the top offset of browser's scrool bar
                    $(window).scroll(function () {
                        $('#image_box').animate({top:$(window).scrollTop() + "px" }, {queue:false, duration:350});
                    });
                    //when the close button at right corner of the message box is clicked
                    $('#close_image_box').click(function () {
                        //the messagebox gets scrool down with top property and gets hidden with zero opacity
                        $('#image_box').animate({ top:"+=15px", opacity:0 }, "slow");
                    });

                    //hoving over a line selects it
                    $("tr").hover(
                            function () {
                                $(this).addClass("hover");
                            },
                            function () {
                                $(this).removeClass("hover");
                            });

                    

        });

        function toggleStudents() {
            /* we don't use .toggle since the state may be inaccurate from a page reload */
            if ($('#student_checkbox').is(':checked')) {
                $(".student").show();
            } else {
                $(".student").hide();
            }
            $("#filterBoxOne").trigger("keyup");
        }

        function toggleStaff() {
            if ($('#staff_checkbox').is(':checked')) {
                $(".staff").show();
            } else {
                $(".staff").hide();
            }
            $("#filterBoxOne").trigger("keyup");
        }

        function updateImage(uri, label) {
            $('#image_box_image').prop("src", uri);

            $('#image_box_label').text(label);
        }


    </script>
<% end %>


<% if can? :create, User %>
    <%= link_to 'New person', new_person_path %>
<% end %>

<div>

  <%= render :partial => "tablesorter_filter_box" %>

</div>

<!-- conference room url
http://info.sv.cmu.edu/twiki/bin/view/Main/CarnegieMellonSiliconValley
-->



<table id="key_contacts_table" class="tablesorter">
  <thead>
  <tr>
    <th>&nbsp;</th>
    <th>Role</th>
    <th>Name</th>
    <th>Contact Details</th>
  </tr>
  </thead>
  <tbody>
  <%if @user_override %>
      <%
            user_description = "#{@user.human_name} | UserID: #{@user.id} | "
            user_description << (@user.is_student ? "Student" : "Staff")
            user_description << " | #{@user.masters_program}"  unless @user.masters_program.blank?
            user_description << " #{@user.masters_track}"  unless @user.masters_track.blank?
      %>
      <%= "You are showing results for:  #{user_description}" %>
  <% end %>
  <% @people.each do |person| %>
    <tr>
      <td class="photobook-img"><%= image_tag(person[:image_uri], :style => "width: 60px") %></td>
      <td><%= person[:title] %>
      <td><%= link_to(person[:human_name], person[:path]) %></td>
      <td><% person[:contact_dtls].each do |k, v| %>
        <%= "#{k}: #{v}" %>  <br />
        <%end %>
        <%= mail_to person[:email] %></td>
    </tr>
  <% end %>
  </tbody>
</table>

<table id="people_table" class="tablesorter" hidden="true" >
  <thead>
  <tr>
    <th></th>
    <th>First name</th>
    <th>Last name</th>
    <th>Contact Details</th>
    <th>Program</th>
  </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<br/>

<% if can? :create, User %>
    <%= link_to 'New person', new_person_path %>
<% end %>

<input type="hidden" id="hidden_field" value="off">
